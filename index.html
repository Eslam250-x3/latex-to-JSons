<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الدليل التفاعلي لكتابة الأسئلة الرياضية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f0f4f8;
        }
        .tab-btn {
            transition: all 0.3s ease;
        }
        .tab-btn.active {
            border-color: #3b82f6;
            background-color: #3b82f6;
            color: white;
        }
        .code-block {
            background-color: #1e293b;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 0.5rem;
            position: relative;
            direction: ltr;
            text-align: left;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .copy-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: #334155;
            color: #94a3b8;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .copy-btn:hover {
            background-color: #475569;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        h2 {
            font-size: 1.875rem;
            font-weight: 700;
            color: #1e3a8a;
            margin-bottom: 1rem;
            border-right: 4px solid #3b82f6;
            padding-right: 1rem;
        }
        h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1e40af;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }
        .rtl-code {
            direction: rtl;
            text-align: right;
        }
        .rule-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem;
            background-color: #f8fafc;
            border-radius: 0.5rem;
            border: 1px solid #e2e8f0;
            font-family: 'Courier New', Courier, monospace;
        }
        .rule-item code {
             color: #0f172a;
        }
        .rule-item .latex-code {
            color: #dc2626;
        }
        .rule-item .result-code {
            color: #16a34a;
            font-weight: bold;
        }
        .try-btn {
            background-color: #e0f2fe;
            color: #0369a1;
            border: none;
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 0.75rem;
            font-family: 'Cairo', sans-serif;
        }
        .try-btn:hover {
            background-color: #bae6fd;
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <div class="max-w-6xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800">الدليل التفاعلي لكتابة الأسئلة الرياضية</h1>
            <p class="text-lg text-gray-600 mt-2">دليلك الشامل لإنشاء أسئلة رياضية فعالة ومتوافقة مع النظام</p>
        </header>

        <!-- Tabs Navigation -->
        <div class="mb-8">
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-4 space-x-reverse" aria-label="Tabs">
                    <button onclick="changeTab(event, 'guide-tab')" class="tab-btn active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg">
                        دليل كتابة الأسئلة
                    </button>
                    <button onclick="changeTab(event, 'symbols-tab')" class="tab-btn text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg">
                        دليل العلامات الرياضية
                    </button>
                    <button onclick="changeTab(event, 'converter-tab')" class="tab-btn text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg">
                        محول LaTeX
                    </button>
                </nav>
            </div>
        </div>

        <!-- Tab Content -->
        <div id="tab-content">
            <!-- Guide Tab -->
            <div id="guide-tab" class="tab-content-item">
                <!-- Content from previous turns, remains unchanged -->
                <div class="card">
                    <h2>1. أنواع الأسئلة المدعومة</h2>
                    <h3>MCQ (اختيار من متعدد)</h3>
                    <p class="mb-2 text-gray-700">استخدم `*` لتحديد الإجابة الصحيحة و `-` للإجابات الخاطئة.</p>
                    <div class="code-block"><button class="copy-btn" onclick="copyCode(this)">نسخ</button><pre><code>[STEM]
ما هو ناتج `2x + 3 = 7`؟
[CHOICES]
- x = 1
* x = 2
- x = 3
- x = 4</code></pre></div>
                    <h3 class="mt-6">String (إجابة نصية)</h3>
                    <p class="mb-2 text-gray-700">تُستخدم للأسئلة التي تتطلب إجابة مباشرة.</p>
                    <div class="code-block"><button class="copy-btn" onclick="copyCode(this)">نسخ</button><pre><code>[STEM]
احسب قيمة `x` في المعادلة `3x - 5 = 10`
[ANSWER]
x = 5</code></pre></div>
                    <h3 class="mt-6">Gap Text (ملء الفراغات)</h3>
                    <p class="mb-2 text-gray-700">ضع الإجابات بالترتيب الصحيح في قسم `[GAPS]`.</p>
                    <div class="code-block"><button class="copy-btn" onclick="copyCode(this)">نسخ</button><pre><code>[STEM]
في المعادلة `ax + b = c`، إذا كان `a = 2` و `c = 10`، فإن `x = [BLANK]` عندما `b = [BLANK]`
[GAPS]
3
4</code></pre></div>
                </div>
                <div class="card">
                    <h2>2. كتابة المعادلات الرياضية</h2>
                    <p class="mb-4 text-gray-700">استخدم العلامات المائلة (backticks) لكتابة الصيغ الرياضية.</p>
                    <ul class="list-disc list-inside space-y-2 text-gray-800">
                        <li>للمعادلات البسيطة: <code class="bg-gray-200 p-1 rounded">`2x + 3 = 7`</code></li>
                        <li>للكسور: <code class="bg-gray-200 p-1 rounded">`x/2 + 3/4 = 5/8`</code></li>
                        <li>للأسس: <code class="bg-gray-200 p-1 rounded">`x^2 + 2x + 1 = 0`</code></li>
                        <li>للجذور: <code class="bg-gray-200 p-1 rounded">`sqrt(x) = 4`</code></li>
                        <li>للدوال المثلثية: <code class="bg-gray-200 p-1 rounded">`sin(x) = 1/2`</code></li>
                    </ul>
                    <p class="mt-4 mb-2 text-gray-700 font-semibold">للمعادلات المعقدة استخدم علامتين مائلتين `` ``:</p>
                    <div class="code-block"><button class="copy-btn" onclick="copyCode(this)">نسخ</button><pre><code>[STEM]
حل المعادلة التربيعية ``x^2 + 5x + 6 = 0``
[CHOICES]
* x = -2, x = -3
- x = 2, x = 3
- x = -1, x = -6
- x = 1, x = 6</code></pre></div>
                </div>
            </div>

            <!-- Symbols Tab -->
            <div id="symbols-tab" class="tab-content-item hidden">
                 <!-- Content from previous turns, remains unchanged -->
                 <div class="card">
                    <h2>🔢 دليل العلامات الرياضية</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="p-4 bg-blue-50 rounded-lg border border-blue-200"><h3 class="mt-0 text-blue-800">1. العمليات الأساسية</h3><pre class="text-gray-700"><code>+   الجمع: 2 + 3 = 5
-   الطرح: 7 - 4 = 3
* الضرب: 5 * 6 = 30
/   القسمة: 12 / 3 = 4
=   يساوي: x = 5
≠   لا يساوي: x ≠ 0</code></pre></div>
                        <div class="p-4 bg-green-50 rounded-lg border border-green-200"><h3 class="mt-0 text-green-800">2. الأسس والجذور</h3><pre class="text-gray-700"><code>^      الأس: x^2, 2^3 = 8
sqrt() الجذر التربيعي: sqrt(16) = 4
cbrt() الجذر التكعيبي: cbrt(8) = 2</code></pre></div>
                        <div class="p-4 bg-yellow-50 rounded-lg border border-yellow-200"><h3 class="mt-0 text-yellow-800">3. الكسور</h3><pre class="text-gray-700"><code>/        للكسور البسيطة: 1/2
frac{}{} للكسور المعقدة: frac{2x+1}{x-3}</code></pre></div>
                        <div class="p-4 bg-purple-50 rounded-lg border border-purple-200"><h3 class="mt-0 text-purple-800">4. المقارنات</h3><pre class="text-gray-700"><code>>   أكبر من: x > 5
<   أصغر من: x < 10
>=  أكبر من أو يساوي: x >= 3
<=  أصغر من أو يساوي: x <= 7</code></pre></div>
                        <div class="p-4 bg-indigo-50 rounded-lg border border-indigo-200"><h3 class="mt-0 text-indigo-800">5. الدوال المثلثية</h3><pre class="text-gray-700"><code>sin() الجيب
cos() جيب التمام
tan() الظل
cot() ظل التمام
sec() القاطع
csc() قاطع التمام</code></pre></div>
                        <div class="p-4 bg-pink-50 rounded-lg border border-pink-200"><h3 class="mt-0 text-pink-800">6. اللوغاريتمات</h3><pre class="text-gray-700"><code>log()   اللوغاريتم العشري
ln()    اللوغاريتم الطبيعي
log_a() لوغاريتم بأساس</code></pre></div>
                        <div class="p-4 bg-gray-50 rounded-lg border border-gray-200"><h3 class="mt-0 text-gray-800">7. الرموز اليونانية</h3><pre class="text-gray-700"><code>π  باي     θ  ثيتا    α  ألفا
β  بيتا    γ  جاما    δ  دلتا
λ  لامدا   μ  مو      σ  سيجما
Ω  أوميجا</code></pre></div>
                        <div class="p-4 bg-teal-50 rounded-lg border border-teal-200"><h3 class="mt-0 text-teal-800">8. المجموعات والمنطق</h3><pre class="text-gray-700"><code>∈   ينتمي إلى
∉   لا ينتمي إلى
⊂   مجموعة جزئية
∪   الاتحاد
∩   التقاطع
∅   المجموعة الخالية</code></pre></div>
                        <div class="p-4 bg-orange-50 rounded-lg border border-orange-200"><h3 class="mt-0 text-orange-800">9. التفاضل والتكامل</h3><pre class="text-gray-700"><code>d/dx  المشتقة
∫     التكامل
∂     المشتقة الجزئية
lim   النهاية</code></pre></div>
                        <div class="p-4 bg-red-50 rounded-lg border border-red-200"><h3 class="mt-0 text-red-800">10. المصفوفات والمتجهات</h3><pre class="text-gray-700"><code>[]  للمصفوفات
||  القيمة المطلقة
→   المتجه</code></pre></div>
                    </div>
                </div>
            </div>

            <!-- Converter Tab -->
            <div id="converter-tab" class="tab-content-item hidden">
                <div class="card">
                    <h2>⚙️ محول LaTeX إلى كود</h2>
                    <p class="text-gray-600 mb-6">أداة لمساعدتك على تحويل صيغ LaTeX إلى التنسيق المبسط المستخدم في النظام. الصق كود LaTeX الخاص بك في المربع الأول واضغط على "تحويل".</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="latex-input" class="block mb-2 font-semibold text-gray-700">أدخل كود LaTeX هنا:</label>
                            <textarea id="latex-input" rows="8" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out" placeholder="e.g., \frac{x^{2} + 3x - 4}{x - 1}"></textarea>
                        </div>
                        <div>
                            <label for="converted-output" class="block mb-2 font-semibold text-gray-700">النتيجة المحولة:</label>
                            <textarea id="converted-output" rows="8" class="w-full p-3 border border-gray-300 rounded-md bg-gray-100" readonly></textarea>
                        </div>
                    </div>
                    <div class="mt-4 text-center">
                        <button onclick="convertLatex()" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition duration-300">
                            تحويل
                        </button>
                    </div>
                </div>
                
                <!-- NEW, ORGANIZED RULES SECTION -->
                <div class="card">
                    <h2 id="rules-header">📜 قواعد التحويل وأمثلة</h2>
                    <p class="text-gray-600 mb-6">فيما يلي القواعد الرئيسية للتحويل مع أمثلة قابلة للنسخ لتجربتها في المحول أعلاه. اضغط على "جربها" لنسخ كود LaTeX إلى المحول.</p>

                    <!-- Category: Fractions -->
                    <div class="mb-6">
                        <h3 class="text-xl font-bold text-gray-800 border-b pb-2 mb-3">1. الكسور (Fractions)</h3>
                        <div class="space-y-2">
                            <div class="rule-item">
                                <div class="flex-grow"><code class="latex-code">\frac{a}{b}</code><span class="mx-2">→</span><code class="result-code">frac{a}{b}</code></div>
                                <button class="try-btn" onclick="copyRuleToConverter('\\frac{a}{b}')">جربها</button>
                            </div>
                        </div>
                    </div>

                    <!-- Category: Exponents & Roots -->
                    <div class="mb-6">
                        <h3 class="text-xl font-bold text-gray-800 border-b pb-2 mb-3">2. الأسس والجذور (Exponents & Roots)</h3>
                        <div class="space-y-2">
                            <div class="rule-item">
                                <div><code class="latex-code">x^{2}</code><span class="mx-2">→</span><code class="result-code">x^2</code></div>
                                <button class="try-btn" onclick="copyRuleToConverter('x^{2}')">جربها</button>
                            </div>
                             <div class="rule-item">
                                <div><code class="latex-code">\sqrt{x+y}</code><span class="mx-2">→</span><code class="result-code">sqrt(x+y)</code></div>
                                <button class="try-btn" onclick="copyRuleToConverter('\\sqrt{x+y}')">جربها</button>
                            </div>
                             <div class="rule-item">
                                <div><code class="latex-code">\sqrt[3]{8}</code><span class="mx-2">→</span><code class="result-code">cbrt(8)</code></div>
                                <button class="try-btn" onclick="copyRuleToConverter('\\sqrt[3]{8}')">جربها</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Category: Functions -->
                    <div class="mb-6">
                        <h3 class="text-xl font-bold text-gray-800 border-b pb-2 mb-3">3. الدوال واللوغاريتمات (Functions & Logs)</h3>
                        <div class="space-y-2">
                            <div class="rule-item">
                                <div><code class="latex-code">\sin(\theta)</code><span class="mx-2">→</span><code class="result-code">sin(θ)</code></div>
                                <button class="try-btn" onclick="copyRuleToConverter('\\sin(\\theta)')">جربها</button>
                            </div>
                             <div class="rule-item">
                                <div><code class="latex-code">\log_{2}(x)</code><span class="mx-2">→</span><code class="result-code">log_2(x)</code></div>
                                <button class="try-btn" onclick="copyRuleToConverter('\\log_{2}(x)')">جربها</button>
                            </div>
                        </div>
                    </div>

                    <!-- Category: Calculus -->
                     <div class="mb-6">
                        <h3 class="text-xl font-bold text-gray-800 border-b pb-2 mb-3">4. التفاضل والتكامل (Calculus)</h3>
                        <div class="space-y-2">
                            <div class="rule-item">
                                <div><code class="latex-code">\int_{a}^{b} x^2 dx</code><span class="mx-2">→</span><code class="result-code">∫_a^b x^2 dx</code></div>
                                <button class="try-btn" onclick="copyRuleToConverter('\\int_{a}^{b} x^2 dx')">جربها</button>
                            </div>
                             <div class="rule-item">
                                <div><code class="latex-code">\lim_{x \to \infty}</code><span class="mx-2">→</span><code class="result-code">lim(x→∞)</code></div>
                                <button class="try-btn" onclick="copyRuleToConverter('\\lim_{x \\to \\infty}')">جربها</button>
                            </div>
                        </div>
                    </div>

                    <!-- Category: Matrices -->
                    <div class="mb-6">
                        <h3 class="text-xl font-bold text-gray-800 border-b pb-2 mb-3">5. المصفوفات (Matrices)</h3>
                        <div class="space-y-2">
                            <div class="rule-item">
                                <div><code class="latex-code">\begin{pmatrix} a & b \\ c & d \end{pmatrix}</code><span class="mx-2">→</span><code class="result-code">(a b;c d)</code></div>
                                <button class="try-btn" onclick="copyRuleToConverter('\\begin{pmatrix} a & b \\\\ c & d \\end{pmatrix}')">جربها</button>
                            </div>
                        </div>
                    </div>

                    <!-- Category: Complex Equations -->
                    <div class="mb-6">
                        <h3 class="text-xl font-bold text-gray-800 border-b pb-2 mb-3">6. المعادلات المعقدة (Complex Equations)</h3>
                         <p class="text-sm text-gray-600 mb-2">المعادلات التي تحتوي على بيئات مثل `cases` أو `align` يتم تغليفها تلقائيًا.</p>
                        <div class="space-y-2">
                            <div class="rule-item">
                                <div><code class="latex-code">\begin{cases} x+y=5 \\ x-y=1 \end{cases}</code><span class="mx-2">→</span><code class="result-code">``...``</code></div>
                                <button class="try-btn" onclick="copyRuleToConverter('\\begin{cases} x+y=5 \\\\ x-y=1 \\end{cases}')">جربها</button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script>
        // Function to change tabs
        function changeTab(event, tabId) {
            const tabContents = document.querySelectorAll('.tab-content-item');
            tabContents.forEach(content => {
                content.classList.add('hidden');
            });

            const tabButtons = document.querySelectorAll('.tab-btn');
            tabButtons.forEach(button => {
                button.classList.remove('active');
            });

            document.getElementById(tabId).classList.remove('hidden');
            event.currentTarget.classList.add('active');
        }

        // Function to copy code from code blocks
        function copyCode(button) {
            const pre = button.nextElementSibling;
            const code = pre.innerText;
            
            const textarea = document.createElement('textarea');
            textarea.value = code;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);

            button.innerText = 'تم النسخ!';
            setTimeout(() => {
                button.innerText = 'نسخ';
            }, 2000);
        }
        
        // New function to copy a rule to the converter input
        function copyRuleToConverter(latexCode) {
            const inputArea = document.getElementById('latex-input');
            const converterTab = document.getElementById('converter-tab');
            
            inputArea.value = latexCode;
            inputArea.focus();
            
            // Automatically trigger the conversion
            convertLatex();
            
            // Scroll to the converter section for visibility
            converterTab.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }


        // --- REVISED AND CORRECTED CONVERSION LOGIC ---
        function convertLatex() {
            const input = document.getElementById('latex-input').value;
            const outputElement = document.getElementById('converted-output');
            
            // Helper function to check for complex environments that should not be parsed
            const isComplexEquation = (latex) => {
                const complexPatterns = [
                    /\\begin\{cases\}/, /\\begin\{align\}/, /\\begin\{equation\}/,
                    /\\begin\{matrix\}/, /\\begin\{pmatrix\}/, /\\begin\{bmatrix\}/,
                    /\\begin\{vmatrix\}/, /\\begin\{array\}/
                ];
                return complexPatterns.some(pattern => pattern.test(latex));
            };

            // If it's a complex equation, wrap it and stop
            if (isComplexEquation(input)) {
                outputElement.value = `\`\`${input}\`\``;
                return;
            }

            let result = input;

            // --- The Conversion Process ---
            // The order of these replacements is important

            // 1. Handle specific commands and environments first
            // Simple matrices (before brace removal)
            result = result.replace(/\\begin\{matrix\}([\s\S]*?)\\end\{matrix\}/g, (m, content) => '[' + content.trim().replace(/\\\\/g, ';').replace(/&/g, ' ') + ']');
            result = result.replace(/\\begin\{pmatrix\}([\s\S]*?)\\end\{pmatrix\}/g, (m, content) => '(' + content.trim().replace(/\\\\/g, ';').replace(/&/g, ' ') + ')');
            result = result.replace(/\\begin\{bmatrix\}([\s\S]*?)\\end\{bmatrix\}/g, (m, content) => '[' + content.trim().replace(/\\\\/g, ';').replace(/&/g, ' ') + ']');
            result = result.replace(/\\begin\{vmatrix\}([\s\S]*?)\\end\{vmatrix\}/g, (m, content) => '|' + content.trim().replace(/\\\\/g, ';').replace(/&/g, ' ') + '|');


            // 2. Fractions and roots
            result = result.replace(/\\frac\{([\s\S]*?)\}\{([\s\S]*?)\}/g, 'frac{$1}{$2}');
            result = result.replace(/\\dfrac\{([\s\S]*?)\}\{([\s\S]*?)\}/g, 'frac{$1}{$2}');
            result = result.replace(/\\tfrac\{([\s\S]*?)\}\{([\s\S]*?)\}/g, 'frac{$1}{$2}');
            result = result.replace(/\\sqrt\[3\]\{([\s\S]*?)\}/g, 'cbrt($1)');
            result = result.replace(/\\sqrt\[([\s\S]*?)\]\{([\s\S]*?)\}/g, 'nthroot($1,$2)');
            result = result.replace(/\\sqrt\{([\s\S]*?)\}/g, 'sqrt($1)');

            // 3. Subscripts and superscripts (carefully, to avoid breaking other rules)
            result = result.replace(/_\{([\s\S]*?)\}/g, '_$1'); // Handle _{...}
            result = result.replace(/\^\{([\s\S]*?)\}/g, '^$1'); // Handle ^{...}
            result = result.replace(/\_(\w|\d)/g, '_$1'); // Handle _x
            result = result.replace(/\^(\w|\d)/g, '^$1'); // Handle ^x


            // 4. Functions and logs
            result = result.replace(/\\(sin|cos|tan|cot|sec|csc|arcsin|arccos|arctan|sinh|cosh|tanh|exp|max|min|sup|inf|gcd|lcm|det|dim|ker|rank)h?/g, '$1');
            result = result.replace(/\\log_\{([\s\S]*?)\}/g, 'log_$1');
            result = result.replace(/\\log/g, 'log');
            result = result.replace(/\\ln/g, 'ln');
            
            // 5. Greek Letters
            const greekLetters = {
                'alpha': 'α', 'beta': 'β', 'gamma': 'γ', 'delta': 'δ', 'epsilon': 'ε', 'varepsilon': 'ε', 'zeta': 'ζ', 'eta': 'η', 'theta': 'θ', 'vartheta': 'θ', 'iota': 'ι', 'kappa': 'κ', 'lambda': 'λ', 'mu': 'μ', 'nu': 'ν', 'xi': 'ξ', 'pi': 'π', 'varpi': 'π', 'rho': 'ρ', 'varrho': 'ρ', 'sigma': 'σ', 'varsigma': 'ς', 'tau': 'τ', 'upsilon': 'υ', 'phi': 'φ', 'varphi': 'φ', 'chi': 'χ', 'psi': 'ψ', 'omega': 'ω',
                'Gamma': 'Γ', 'Delta': 'Δ', 'Theta': 'Θ', 'Lambda': 'Λ', 'Xi': 'Ξ', 'Pi': 'Π', 'Sigma': 'Σ', 'Upsilon': 'Υ', 'Phi': 'Φ', 'Psi': 'Ψ', 'Omega': 'Ω'
            };
            result = result.replace(/\\([a-zA-Z]+)/g, (match, p1) => greekLetters[p1] || match);

            // 6. Operators and Relations
            const ops = { 'cdot': '·', 'times': '×', 'div': '÷', 'pm': '±', 'mp': '∓', 'neq': '≠', 'ne': '≠', 'leq': '≤', 'le': '≤', 'geq': '≥', 'ge': '≥', 'll': '≪', 'gg': '≫', 'approx': '≈', 'equiv': '≡', 'propto': '∝', 'sim': '∼', 'simeq': '≃', 'cong': '≅', 'in': '∈', 'notin': '∉', 'subset': '⊂', 'supset': '⊃', 'subseteq': '⊆', 'supseteq': '⊇', 'cup': '∪', 'cap': '∩', 'emptyset': '∅', 'varnothing': '∅', 'forall': '∀', 'exists': '∃', 'nexists': '∄', 'land': '∧', 'lor': '∨', 'neg': '¬', 'lnot': '¬', 'rightarrow': '→', 'to': '→', 'leftarrow': '←', 'leftrightarrow': '↔', 'Rightarrow': '⇒', 'Leftarrow': '⇐', 'Leftrightarrow': '⇔', 'uparrow': '↑', 'downarrow': '↓', 'mapsto': '↦', 'infty': '∞', 'partial': '∂', 'nabla': '∇', 'int': '∫', 'oint': '∮', 'sum': 'Σ', 'prod': 'Π', 'degree': '°' };
            result = result.replace(/\\([a-zA-Z]+)/g, (match, p1) => ops[p1] || match);
            
            // 7. Limits
            result = result.replace(/\\lim_\{([\s\S]*?)\}/g, (m, p1) => `lim(${p1.replace(/\\to|\\rightarrow/g, '→')})`);

            // 8. Final cleanup of braces and text commands
            result = result.replace(/\\(text|mathrm|mathbf|mathit|mathcal|mathbb|mathfrak)\{([\s\S]*?)\}/g, '$2');
            result = result.replace(/\\left\(|\\right\)|\\left\[|\\right\]|\\left\{|\\right\}/g, '');
            // Remove braces carefully
            result = result.replace(/\{/g, '').replace(/\}/g, ''); 
            result = result.replace(/\\\\/g, '\n'); // newlines
            result = result.replace(/\s+/g, ' ').trim(); // Consolidate whitespace

            outputElement.value = result;
        }
    </script>
</body>
</html>
